#!/usr/bin/env ruby
# frozen_string_literal: true

Dir.chdir(File.dirname(__dir__))

require('bundler/setup')
require('nokogiri')
require('open-uri')

BASE_DIR = Dir.pwd.freeze
CODE_FILE = File.join(BASE_DIR, 'lib', 'htx', 'template.rb').freeze
MOZILLA_BASE_URL = 'https://developer.mozilla.org/en-US/docs/Web/SVG/'
MAX_LINE_LENGTH = 108

code = File.read(CODE_FILE)
error = nil

[
  ['TAG_MAP', 'Element', '.main-page-content > section > div.section-content > ul > li > a > code'],
  ['ATTR_MAP', 'Attribute', '.main-page-content > section > div.section-content > ul > li > code > a'],
].each do |(const, page, selector)|
  result = code.sub!(/^( *)#{const} = [^\]]+/) do
    indent_const = $1
    indent = "#{indent_const}  "
    break_at = MAX_LINE_LENGTH - indent.size

    doc = Nokogiri::HTML(URI.open("#{MOZILLA_BASE_URL}#{page}"))
    items = doc.css(selector)
               .map { |n| n.text.delete_prefix('<').delete_suffix('>') }
               .select { |t| t.match?(/[A-Z]/) }
               .sort
               .join("\n#{indent}")

    "#{indent_const}#{const} = %w[\n#{indent}#{items}\n#{indent_const}"
  end

  if result
    puts("\e[32m\u2714 #{const} updated in #{CODE_FILE}\e[39m")
  else
    $stderr.puts("\e[31m\u2718 #{const} not updated in #{CODE_FILE} (could not find definition)\e[39m")
    error = true
  end
end

File.write(CODE_FILE, code)
exit(1) if error
